
import numpy as np
import scipy as scp
from numpy import pi

def calculate_exvolume_redfactor():
    """
    Calculates DEER background reduction factor alpha(d)
    See
    Kattnig et al
    J.Phys. Chem. B, 117, 16542 (2013)
    https://doi.org/10.1021/jp408338q
    The background reduction factor alpha(d) is defined in Eq.(18)
    For large d, one can use the limiting expression
    alpha = (3/2/pi)*(2*pi/3-sqrt(3)./d) 
    as an excellent approximation (error at d
    """

    def KK(d):
        q = np.sqrt(6*d/pi)
        S,C = scp.special.fresnel(q)
        y = 1 - (np.cos(d)*C+np.sin(d)*S)/q
        y[y==0] = 0
        return y

    def h(d):
        d = np.atleast_1d(d)
        y = np.zeros(np.shape(d))
        for k in range(len(d)):
            y[k],_ = scp.integrate.quad(lambda x:(1-x**2)*Si((1-x**2)*d[k]),0,np.sqrt(3))
        return y

    def Si(t):
        t = np.atleast_1d(t)
        y = np.zeros(np.shape(t))
        for k in range(len(t)):
            y[k],_ = scp.integrate.quad(lambda x:np.sin(x)/(x+np.finfo(float).eps),0,t[k],limit=1000)  
            y[y==0] = 0
        return y

    # Set up dR range
    #-------------------------------------------------------------------------------
    # dR = A*t/R^3, where t is time, R is excluded-volume radius, and A is the
    # dipolar constant (in units compatible with t and R)
    dRlin = np.arange(0,20,0.05)
    dRlog = 10**(np.arange(1,3,0.05))
    dRlog = np.delete(dRlog, np.where(dRlog < max(dRlin)))
    dR = np.concatenate((dRlin, dRlog))

    # Evaluate reduction factor alpha as a function of dR
    #-------------------------------------------------------------------------------
    h_ = h(dR)
    K_ = KK(dR)
    alpha = (3/2/pi)*(h_ - np.sqrt(3)/dR*K_)
    alpha[dR==0] = 0

    return alpha


def load_exvolume_redfactor():

    """
    Cached DEER background reduction factors alpha(d)
    These values are the output of the function calculate_exvolume_redfactor() used 
    by the background model bg_hom3dex(). 

    This serves as a considerable speedup due to the long evaluation times of 
    calculate_exvolume_redfactor(). 
    """

    alphas = [0, 0.0165379 , 0.03306399, 0.0495665 , 0.0660337 , 0.08245396, 0.09881578, 0.11510776, 0.13131871, 0.14743763, 0.16345374, 0.17935649,
    0.19513563, 0.21078121, 0.22628356, 0.24163339, 0.25682175, 0.27184007, 0.28668016, 0.30133425, 0.315795  , 0.33005549, 0.34410924, 0.35795025,
    0.37157294, 0.38497223, 0.3981435 , 0.41108259, 0.42378583, 0.43625001, 0.44847239, 0.46045071, 0.47218314, 0.48366834, 0.49490538, 0.50589378,
    0.51663349, 0.52712486, 0.53736865, 0.54736597, 0.55711835, 0.56662763, 0.575896  , 0.58492597, 0.59372033, 0.60228219, 0.61061487, 0.61872197,
    0.62660729, 0.63427484, 0.64172881, 0.64897354, 0.65601352, 0.66285337, 0.6694978 , 0.6759516 , 0.68221963, 0.68830681, 0.69421806, 0.69995833,
    0.70553257, 0.7109457 , 0.71620261, 0.72130814, 0.72626707, 0.73108411, 0.73576389, 0.74031093, 0.74472967, 0.74902443, 0.75319939, 0.75725864,
    0.76120613, 0.76504566, 0.76878091, 0.77241541, 0.77595255, 0.77939559, 0.78274762, 0.78601163, 0.78919043, 0.79228672, 0.79530303, 0.79824181,
    0.80110534, 0.80389579, 0.80661521, 0.80926555, 0.81184864, 0.81436621, 0.81681989, 0.81921124, 0.82154171, 0.82381269, 0.82602551, 0.82818142,
    0.83028161, 0.83232724, 0.83431942, 0.8362592 , 0.83814762, 0.83998568, 0.84177439, 0.84351469, 0.84520756, 0.84685393, 0.84845476, 0.85001099,
    0.85152356, 0.85299344, 0.85442157, 0.85580894, 0.85715652, 0.85846531, 0.85973632, 0.86097057, 0.8621691 , 0.86333296, 0.86446321, 0.86556094,
    0.86662722, 0.86766317, 0.86866987, 0.86964846, 0.87060005, 0.87152575, 0.87242669, 0.87330399, 0.87415877, 0.87499212, 0.87580516, 0.87659895,
    0.87737458, 0.87813309, 0.87887552, 0.87960287, 0.88031614, 0.88101627, 0.88170421, 0.88238084, 0.88304703, 0.88370361, 0.88435138, 0.8849911,
    0.88562348, 0.8862492 , 0.88686891, 0.8874832 , 0.88809264, 0.88869775, 0.88929899, 0.88989682, 0.89049162, 0.89108377, 0.89167357, 0.89226132,
    0.89284726, 0.89343161, 0.89401453, 0.89459619, 0.89517669, 0.89575611, 0.89633453, 0.89691197, 0.89748845, 0.89806394, 0.89863842, 0.89921184,
    0.89978412, 0.9003552 , 0.90092496, 0.90149331, 0.90206013, 0.9026253, 0.90318868, 0.90375014, 0.90430955, 0.90486676, 0.90542163, 0.90597402,
    0.9065238 , 0.90707082, 0.90761494, 0.90815605, 0.908694  , 0.90922869, 0.90975999, 0.91028779, 0.91081199, 0.91133248, 0.91184919, 0.912362,
    0.91287086, 0.91337568, 0.91387639, 0.91437294, 0.91486525, 0.91535328, 0.91583698, 0.91631631, 0.91679122, 0.91726167, 0.91772764, 0.9181891,
    0.918646  , 0.91909834, 0.91954607, 0.91998919, 0.92042766, 0.92086147, 0.9212906 , 0.92171502, 0.92213472, 0.92254968, 0.92295987, 0.92336529,
    0.92376591, 0.92416171, 0.92455268, 0.9249388 , 0.92532005, 0.92569642, 0.92606789, 0.92643446, 0.9267961 , 0.92715281, 0.92750459, 0.92785142,
    0.92819331, 0.92853026, 0.92886226, 0.92918934, 0.9295115 , 0.92982877, 0.93014115, 0.93044868, 0.9307514 , 0.93104933, 0.93134252, 0.93163103,
    0.93191489, 0.93219418, 0.93246896, 0.93273931, 0.93300529, 0.93326699, 0.93352451, 0.93377794, 0.93402738, 0.93427293, 0.93451471, 0.93475282,
    0.93498739, 0.93521855, 0.93544641, 0.93567111, 0.93589278, 0.93611156, 0.93632757, 0.93654096, 0.93675187, 0.93696044, 0.93716679, 0.93737108,
    0.93757343, 0.93777398, 0.93797287, 0.93817022, 0.93836616, 0.93856082, 0.93875431, 0.93894675, 0.93913826, 0.93932893, 0.93951887, 0.93970817,
    0.93989693, 0.94008523, 0.94027314, 0.94046075, 0.94064811, 0.94083529, 0.94102234, 0.94120931, 0.94139624, 0.94158318, 0.94177013, 0.94195715,
    0.94214423, 0.9423314 , 0.94251866, 0.94270602, 0.94289348, 0.94308103, 0.94326866, 0.94345635, 0.9436441 , 0.94383187, 0.94401965, 0.94420741,
    0.94439512, 0.94458275, 0.94477026, 0.94495763, 0.94514482, 0.94533179, 0.9455185 , 0.94570492, 0.945891  , 0.94607672, 0.94626202, 0.94644688,
    0.94663125, 0.9468151 , 0.94699838, 0.94718108, 0.94736314, 0.94754453, 0.94772523, 0.94790519, 0.94808439, 0.94826279, 0.94844037, 0.9486171,
    0.94879294, 0.94896787, 0.94914187, 0.9493149 , 0.94948695, 0.94965799, 0.94982799, 0.94999694, 0.95016481, 0.95033157, 0.95049721, 0.95066171,
    0.95082504, 0.95098719, 0.95114814, 0.95130786, 0.95146634, 0.95162355, 0.95177949, 0.95193413, 0.95208745, 0.95223944, 0.95239008, 0.95253936,
    0.95268726, 0.95283376, 0.95297886, 0.95312254, 0.95326478, 0.95340559, 0.95354494, 0.95368283, 0.95381925, 0.9539542 , 0.95408768, 0.95421967,
    0.95435019, 0.95447923, 0.9546068 , 0.9547329 , 0.95485754, 0.95498072, 0.95510247, 0.95522278, 0.95534169, 0.9554592 , 0.95557533, 0.95569012,
    0.95580358, 0.95591573, 0.95602662, 0.95613626, 0.95624469, 0.95635195, 0.95645806, 0.95656307, 0.95666702, 0.95676994, 0.95687188, 0.95697288,
    0.95707298, 0.95717223, 0.95727067, 0.95736835, 0.95746531, 0.9575616, 0.95765726, 0.95775234, 0.95784689, 0.95794094, 0.95803455, 0.95812775,
    0.95822058, 0.9583131 , 0.95840533, 0.95849731, 0.95850213, 0.96297968, 0.96718482, 0.97057831, 0.97389591, 0.97669565, 0.97918612, 0.98149099,
    0.98351957, 0.98531027, 0.98690039, 0.98831063, 0.98958932, 0.990719, 0.99173422, 0.99263255, 0.99343229, 0.99414394, 0.99478124, 0.99534857,
    0.99585575, 0.99630597, 0.99670802, 0.99706603, 0.99738459, 0.99766907, 0.99792255, 0.99815108, 0.99835514, 0.99853049, 0.9986903 , 0.99882683,
    0.99895631, 0.9990983]

    dR = [0.00000000e+00, 5.00000000e-02, 1.00000000e-01, 1.50000000e-01, 2.00000000e-01, 2.50000000e-01, 3.00000000e-01, 3.50000000e-01,
    4.00000000e-01, 4.50000000e-01, 5.00000000e-01, 5.50000000e-01, 6.00000000e-01, 6.50000000e-01, 7.00000000e-01, 7.50000000e-01,
    8.00000000e-01, 8.50000000e-01, 9.00000000e-01, 9.50000000e-01, 1.00000000e+00, 1.05000000e+00, 1.10000000e+00, 1.15000000e+00,
    1.20000000e+00, 1.25000000e+00, 1.30000000e+00, 1.35000000e+00, 1.40000000e+00, 1.45000000e+00, 1.50000000e+00, 1.55000000e+00,
    1.60000000e+00, 1.65000000e+00, 1.70000000e+00, 1.75000000e+00, 1.80000000e+00, 1.85000000e+00, 1.90000000e+00, 1.95000000e+00,
    2.00000000e+00, 2.05000000e+00, 2.10000000e+00, 2.15000000e+00, 2.20000000e+00, 2.25000000e+00, 2.30000000e+00, 2.35000000e+00,
    2.40000000e+00, 2.45000000e+00, 2.50000000e+00, 2.55000000e+00, 2.60000000e+00, 2.65000000e+00, 2.70000000e+00, 2.75000000e+00,
    2.80000000e+00, 2.85000000e+00, 2.90000000e+00, 2.95000000e+00, 3.00000000e+00, 3.05000000e+00, 3.10000000e+00, 3.15000000e+00,
    3.20000000e+00, 3.25000000e+00, 3.30000000e+00, 3.35000000e+00, 3.40000000e+00, 3.45000000e+00, 3.50000000e+00, 3.55000000e+00,
    3.60000000e+00, 3.65000000e+00, 3.70000000e+00, 3.75000000e+00, 3.80000000e+00, 3.85000000e+00, 3.90000000e+00, 3.95000000e+00,
    4.00000000e+00, 4.05000000e+00, 4.10000000e+00, 4.15000000e+00, 4.20000000e+00, 4.25000000e+00, 4.30000000e+00, 4.35000000e+00,
    4.40000000e+00, 4.45000000e+00, 4.50000000e+00, 4.55000000e+00, 4.60000000e+00, 4.65000000e+00, 4.70000000e+00, 4.75000000e+00,
    4.80000000e+00, 4.85000000e+00, 4.90000000e+00, 4.95000000e+00, 5.00000000e+00, 5.05000000e+00, 5.10000000e+00, 5.15000000e+00,
    5.20000000e+00, 5.25000000e+00, 5.30000000e+00, 5.35000000e+00, 5.40000000e+00, 5.45000000e+00, 5.50000000e+00, 5.55000000e+00,
    5.60000000e+00, 5.65000000e+00, 5.70000000e+00, 5.75000000e+00, 5.80000000e+00, 5.85000000e+00, 5.90000000e+00, 5.95000000e+00,
    6.00000000e+00, 6.05000000e+00, 6.10000000e+00, 6.15000000e+00, 6.20000000e+00, 6.25000000e+00, 6.30000000e+00, 6.35000000e+00,
    6.40000000e+00, 6.45000000e+00, 6.50000000e+00, 6.55000000e+00, 6.60000000e+00, 6.65000000e+00, 6.70000000e+00, 6.75000000e+00,
    6.80000000e+00, 6.85000000e+00, 6.90000000e+00, 6.95000000e+00, 7.00000000e+00, 7.05000000e+00, 7.10000000e+00, 7.15000000e+00,
    7.20000000e+00, 7.25000000e+00, 7.30000000e+00, 7.35000000e+00, 7.40000000e+00, 7.45000000e+00, 7.50000000e+00, 7.55000000e+00,
    7.60000000e+00, 7.65000000e+00, 7.70000000e+00, 7.75000000e+00, 7.80000000e+00, 7.85000000e+00, 7.90000000e+00, 7.95000000e+00,
    8.00000000e+00, 8.05000000e+00, 8.10000000e+00, 8.15000000e+00, 8.20000000e+00, 8.25000000e+00, 8.30000000e+00, 8.35000000e+00,
    8.40000000e+00, 8.45000000e+00, 8.50000000e+00, 8.55000000e+00, 8.60000000e+00, 8.65000000e+00, 8.70000000e+00, 8.75000000e+00,
    8.80000000e+00, 8.85000000e+00, 8.90000000e+00, 8.95000000e+00, 9.00000000e+00, 9.05000000e+00, 9.10000000e+00, 9.15000000e+00,
    9.20000000e+00, 9.25000000e+00, 9.30000000e+00, 9.35000000e+00, 9.40000000e+00, 9.45000000e+00, 9.50000000e+00, 9.55000000e+00,
    9.60000000e+00, 9.65000000e+00, 9.70000000e+00, 9.75000000e+00, 9.80000000e+00, 9.85000000e+00, 9.90000000e+00, 9.95000000e+00,
    1.00000000e+01, 1.00500000e+01, 1.01000000e+01, 1.01500000e+01, 1.02000000e+01, 1.02500000e+01, 1.03000000e+01, 1.03500000e+01,
    1.04000000e+01, 1.04500000e+01, 1.05000000e+01, 1.05500000e+01, 1.06000000e+01, 1.06500000e+01, 1.07000000e+01, 1.07500000e+01,
    1.08000000e+01, 1.08500000e+01, 1.09000000e+01, 1.09500000e+01, 1.10000000e+01, 1.10500000e+01, 1.11000000e+01, 1.11500000e+01,
    1.12000000e+01, 1.12500000e+01, 1.13000000e+01, 1.13500000e+01, 1.14000000e+01, 1.14500000e+01, 1.15000000e+01, 1.15500000e+01,
    1.16000000e+01, 1.16500000e+01, 1.17000000e+01, 1.17500000e+01, 1.18000000e+01, 1.18500000e+01, 1.19000000e+01, 1.19500000e+01,
    1.20000000e+01, 1.20500000e+01, 1.21000000e+01, 1.21500000e+01, 1.22000000e+01, 1.22500000e+01, 1.23000000e+01, 1.23500000e+01,
    1.24000000e+01, 1.24500000e+01, 1.25000000e+01, 1.25500000e+01, 1.26000000e+01, 1.26500000e+01, 1.27000000e+01, 1.27500000e+01,
    1.28000000e+01, 1.28500000e+01, 1.29000000e+01, 1.29500000e+01, 1.30000000e+01, 1.30500000e+01, 1.31000000e+01, 1.31500000e+01,
    1.32000000e+01, 1.32500000e+01, 1.33000000e+01, 1.33500000e+01, 1.34000000e+01, 1.34500000e+01, 1.35000000e+01, 1.35500000e+01,
    1.36000000e+01, 1.36500000e+01, 1.37000000e+01, 1.37500000e+01, 1.38000000e+01, 1.38500000e+01, 1.39000000e+01, 1.39500000e+01,
    1.40000000e+01, 1.40500000e+01, 1.41000000e+01, 1.41500000e+01, 1.42000000e+01, 1.42500000e+01, 1.43000000e+01, 1.43500000e+01,
    1.44000000e+01, 1.44500000e+01, 1.45000000e+01, 1.45500000e+01, 1.46000000e+01, 1.46500000e+01, 1.47000000e+01, 1.47500000e+01,
    1.48000000e+01, 1.48500000e+01, 1.49000000e+01, 1.49500000e+01, 1.50000000e+01, 1.50500000e+01, 1.51000000e+01, 1.51500000e+01,
    1.52000000e+01, 1.52500000e+01, 1.53000000e+01, 1.53500000e+01, 1.54000000e+01, 1.54500000e+01, 1.55000000e+01, 1.55500000e+01,
    1.56000000e+01, 1.56500000e+01, 1.57000000e+01, 1.57500000e+01, 1.58000000e+01, 1.58500000e+01, 1.59000000e+01, 1.59500000e+01,
    1.60000000e+01, 1.60500000e+01, 1.61000000e+01, 1.61500000e+01, 1.62000000e+01, 1.62500000e+01, 1.63000000e+01, 1.63500000e+01,
    1.64000000e+01, 1.64500000e+01, 1.65000000e+01, 1.65500000e+01, 1.66000000e+01, 1.66500000e+01, 1.67000000e+01, 1.67500000e+01,
    1.68000000e+01, 1.68500000e+01, 1.69000000e+01, 1.69500000e+01, 1.70000000e+01, 1.70500000e+01, 1.71000000e+01, 1.71500000e+01,
    1.72000000e+01, 1.72500000e+01, 1.73000000e+01, 1.73500000e+01, 1.74000000e+01, 1.74500000e+01, 1.75000000e+01, 1.75500000e+01,
    1.76000000e+01, 1.76500000e+01, 1.77000000e+01, 1.77500000e+01, 1.78000000e+01, 1.78500000e+01, 1.79000000e+01, 1.79500000e+01,
    1.80000000e+01, 1.80500000e+01, 1.81000000e+01, 1.81500000e+01, 1.82000000e+01, 1.82500000e+01, 1.83000000e+01, 1.83500000e+01,
    1.84000000e+01, 1.84500000e+01, 1.85000000e+01, 1.85500000e+01, 1.86000000e+01, 1.86500000e+01, 1.87000000e+01, 1.87500000e+01,
    1.88000000e+01, 1.88500000e+01, 1.89000000e+01, 1.89500000e+01, 1.90000000e+01, 1.90500000e+01, 1.91000000e+01, 1.91500000e+01,
    1.92000000e+01, 1.92500000e+01, 1.93000000e+01, 1.93500000e+01, 1.94000000e+01, 1.94500000e+01, 1.95000000e+01, 1.95500000e+01,
    1.96000000e+01, 1.96500000e+01, 1.97000000e+01, 1.97500000e+01, 1.98000000e+01, 1.98500000e+01, 1.99000000e+01, 1.99500000e+01,
    1.99526231e+01, 2.23872114e+01, 2.51188643e+01, 2.81838293e+01, 3.16227766e+01, 3.54813389e+01, 3.98107171e+01, 4.46683592e+01,
    5.01187234e+01, 5.62341325e+01, 6.30957344e+01, 7.07945784e+01, 7.94328235e+01, 8.91250938e+01, 1.00000000e+02, 1.12201845e+02,
    1.25892541e+02, 1.41253754e+02, 1.58489319e+02, 1.77827941e+02, 1.99526231e+02, 2.23872114e+02, 2.51188643e+02, 2.81838293e+02,
    3.16227766e+02, 3.54813389e+02, 3.98107171e+02, 4.46683592e+02, 5.01187234e+02, 5.62341325e+02, 6.30957344e+02, 7.07945784e+02,
    7.94328235e+02, 8.91250938e+02]

    return dR,alphas