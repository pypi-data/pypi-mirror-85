(self["webpackChunk_jupyterlab_application_top"]=self["webpackChunk_jupyterlab_application_top"]||[]).push([[1739],{61739:(e,t,s)=>{"use strict";s.r(t);s.d(t,{Completer:()=>q,CompleterModel:()=>C,CompletionConnector:()=>m,CompletionHandler:()=>d,ContextConnector:()=>u,ICompletionManager:()=>N,KernelConnector:()=>h});var n=s(66995);var i=s(74723);var r=s(63117);var o=s(82507);class l extends o.DataConnector{fetch(e){return Promise.reject("Attempting to fetch with DummyConnector. Please ensure connector responseType is set.")}}const a="jp-mod-completer-enabled";const c="jp-mod-completer-active";class d{constructor(e){this._editor=null;this._enabled=false;this._pending=0;this._isDisposed=false;this.completer=e.completer;this.completer.selected.connect(this.onCompletionSelected,this);this.completer.visibilityChanged.connect(this.onVisibilityChanged,this);this._connector=e.connector}get connector(){if("responseType"in this._connector){return new l}return this._connector}set connector(e){this._connector=e}get editor(){return this._editor}set editor(e){if(e===this._editor){return}let t=this._editor;if(t&&!t.isDisposed){const e=t.model;t.host.classList.remove(a);t.host.classList.remove(c);e.selections.changed.disconnect(this.onSelectionsChanged,this);e.value.changed.disconnect(this.onTextChanged,this)}this.completer.reset();this.completer.editor=e;t=this._editor=e;if(t){const e=t.model;this._enabled=false;e.selections.changed.connect(this.onSelectionsChanged,this);e.value.changed.connect(this.onTextChanged,this);this.onSelectionsChanged()}}get isDisposed(){return this._isDisposed}dispose(){if(this.isDisposed){return}this._isDisposed=true;r.Signal.clearData(this)}invoke(){i.MessageLoop.sendMessage(this,d.Msg.InvokeRequest)}processMessage(e){switch(e.type){case d.Msg.InvokeRequest.type:this.onInvokeRequest(e);break;default:break}}getState(e,t){return{text:e.model.value.text,lineHeight:e.lineHeight,charWidth:e.charWidth,line:t.line,column:t.column}}onCompletionSelected(e,t){const s=e.model;const n=this._editor;if(!n||!s){return}const i=s.createPatch(t);if(!i){return}const{start:r,end:o,value:l}=i;n.model.value.remove(r,o);n.model.value.insert(r,l)}onInvokeRequest(e){if(!this.completer.model){return}if(this.completer.model.original){return}const t=this._editor;if(t){this._makeRequest(t.getCursorPosition()).catch((e=>{console.warn("Invoke request bailed",e)}))}}onSelectionsChanged(){const e=this.completer.model;const t=this._editor;if(!t){return}const s=t.host;if(!e){this._enabled=false;s.classList.remove(a);return}if(e.subsetMatch){return}const n=t.getCursorPosition();const i=t.getLine(n.line);if(!i){this._enabled=false;e.reset(true);s.classList.remove(a);return}const{start:r,end:o}=t.getSelection();if(r.column!==o.column||r.line!==o.line){this._enabled=false;e.reset(true);s.classList.remove(a);return}if(i.slice(0,n.column).match(/^\s*$/)){this._enabled=false;e.reset(true);s.classList.remove(a);return}if(!this._enabled){this._enabled=true;s.classList.add(a)}e.handleCursorChange(this.getState(t,t.getCursorPosition()))}onTextChanged(){const e=this.completer.model;if(!e||!this._enabled){return}const t=this.editor;if(!t){return}const{start:s,end:n}=t.getSelection();if(s.column!==n.column||s.line!==n.line){return}e.handleTextChange(this.getState(t,t.getCursorPosition()))}onVisibilityChanged(e){if(e.isDisposed||e.isHidden){if(this._editor){this._editor.host.classList.remove(c);this._editor.focus()}return}if(this._editor){this._editor.host.classList.add(c)}}_makeRequest(e){const t=this.editor;if(!t){return Promise.reject(new Error("No active editor"))}const s=t.model.value.text;const i=n.Text.jsIndexToCharIndex(t.getOffsetAt(e),s);const r=++this._pending;const o=this.getState(t,e);const l={text:s,offset:i};if(this._isICompletionItemsConnector(this._connector)){return this._connector.fetch(l).then((e=>{this._validate(r,l);if(!e){throw new Error(`Invalid request: ${l}`)}this._onFetchItemsReply(o,e)})).catch((e=>{this._onFailure()}))}return this._connector.fetch(l).then((e=>{this._validate(r,l);if(!e){throw new Error(`Invalid request: ${l}`)}this._onReply(o,e)})).catch((e=>{this._onFailure()}))}_isICompletionItemsConnector(e){return e.responseType===d.ICompletionItemsResponseType}_validate(e,t){if(this.isDisposed){throw new Error("Handler is disposed")}if(e!==this._pending){throw new Error("A newer completion request is pending")}}_updateModel(e,t,s){const i=this.completer.model;const r=e.text;if(!i){return null}i.original=e;i.cursor={start:n.Text.charIndexToJsIndex(t,r),end:n.Text.charIndexToJsIndex(s,r)};return i}_onReply(e,t){const s=this._updateModel(e,t.start,t.end);if(!s){return}const n=[];const i=new Set(t.matches||[]);if(t.matches){i.forEach((e=>{n.push(e)}))}const r=t.metadata||{};const o=r._jupyter_types_experimental;const l={};if(o){o.forEach((e=>{const t=e.text;const s=e.type;if(i.has(t)&&s!=="<unknown>"){l[t]=s}}))}s.setOptions(n,l)}_onFetchItemsReply(e,t){const s=this._updateModel(e,t.start,t.end);if(!s){return}if(s.setCompletionItems){s.setCompletionItems(t.items)}}_onFailure(){const e=this.completer.model;if(e){e.reset(true)}}}(function(e){e.ICompletionItemsResponseType="ICompletionItemsReply";let t;(function(e){e.InvokeRequest=new i.Message("invoke-request")})(t=e.Msg||(e.Msg={}))})(d||(d={}));class h extends o.DataConnector{constructor(e){super();this._session=e.session}async fetch(e){var t;const s=(t=this._session)===null||t===void 0?void 0:t.kernel;if(!s){throw new Error("No kernel for completion request.")}const n={code:e.text,cursor_pos:e.offset};const i=await s.requestComplete(n);const r=i.content;if(r.status!=="ok"){throw new Error("Completion fetch failed to return successfully.")}return{start:r.cursor_start,end:r.cursor_end,matches:r.matches,metadata:r.metadata}}}class u extends o.DataConnector{constructor(e){super();this._editor=e.editor}fetch(e){if(!this._editor){return Promise.reject("No editor")}return new Promise((e=>{e(p.contextHint(this._editor))}))}}var p;(function(e){function t(e){const t=e.getCursorPosition();const n=e.getTokenForPosition(t);const i=s(n,e);const r=i.filter((e=>e.type)).map((e=>e.value));const o=Array.from(new Set(r));return{start:n.offset,end:n.offset+n.value.length,matches:o,metadata:{}}}e.contextHint=t;function s(e,t){const s=t.getTokens();return s.filter((t=>t.value.indexOf(e.value)===0&&t.value!==e.value))}})(p||(p={}));class m extends o.DataConnector{constructor(e){super();this._kernel=new h(e);this._context=new u(e)}fetch(e){return Promise.all([this._kernel.fetch(e),this._context.fetch(e)]).then((([e,t])=>f.mergeReplies(e,t)))}}var f;(function(e){function t(e,t){if(e.matches.length===0){return t}else if(t.matches.length===0){return e}const s=e.matches.slice();const n=s.reduce(((e,t)=>{e[t]=null;return e}),{});t.matches.forEach((e=>{if(!(e in n)){s.push(e)}}));return Object.assign(Object.assign({},e),{matches:s})}e.mergeReplies=t})(f||(f={}));var _=s(93269);var g=s(52191);class C{constructor(){this._current=null;this._cursor=null;this._isDisposed=false;this._completionItems=[];this._options=[];this._original=null;this._query="";this._subsetMatch=false;this._typeMap={};this._orderedTypes=[];this._stateChanged=new r.Signal(this)}get stateChanged(){return this._stateChanged}get original(){return this._original}set original(e){const t=this._original===e||this._original&&e&&g.JSONExt.deepEqual(e,this._original);if(t){return}this._reset();this._current=this._original=e;this._stateChanged.emit(undefined)}get current(){return this._current}set current(e){const t=this._current===e||this._current&&e&&g.JSONExt.deepEqual(e,this._current);if(t){return}const s=this._original;if(!s){return}const n=this._cursor;if(!n){return}const i=this._current=e;if(!i){this._stateChanged.emit(undefined);return}const r=s.text.split("\n")[s.line];const o=i.text.split("\n")[i.line];if(!this._subsetMatch&&o.length<r.length){this.reset(true);return}const{start:l,end:a}=n;let c=i.text.substring(l);const d=s.text.substring(a);c=c.substring(0,c.lastIndexOf(d));this._query=c;this._stateChanged.emit(undefined)}get cursor(){return this._cursor}set cursor(e){if(!this.original){return}this._cursor=e}get query(){return this._query}set query(e){this._query=e}get subsetMatch(){return this._subsetMatch}set subsetMatch(e){this._subsetMatch=e}get isDisposed(){return this._isDisposed}dispose(){if(this._isDisposed){return}this._isDisposed=true;r.Signal.clearData(this)}completionItems(){let e=this._query;if(e){return this._markup(e)}return this._completionItems}setCompletionItems(e){if(g.JSONExt.deepEqual(e,this._completionItems)){return}this._completionItems=e;this._orderedTypes=y.findOrderedCompletionItemTypes(this._completionItems);this._stateChanged.emit(undefined)}items(){return this._filter()}options(){return(0,_.iter)(this._options)}typeMap(){return this._typeMap}orderedTypes(){return this._orderedTypes}setOptions(e,t){const s=(0,_.toArray)(e||[]);const n=t||{};if(g.JSONExt.deepEqual(s,this._options)&&g.JSONExt.deepEqual(n,this._typeMap)){return}if(s.length){this._options=s;this._typeMap=n;this._orderedTypes=y.findOrderedTypes(n)}else{this._options=[];this._typeMap={};this._orderedTypes=[]}this._stateChanged.emit(undefined)}handleCursorChange(e){if(!this._original){return}const{column:t,line:s}=e;const{current:n,original:i}=this;if(!i){return}if(s!==i.line){this.reset(true);return}if(t<i.column){this.reset(true);return}const{cursor:r}=this;if(!r||!n){return}const o=r.end-r.start;const l=i.text.split("\n")[i.line];const a=n.text.split("\n")[n.line];const c=a.length-l.length;if(t>i.column+o+c){this.reset(true);return}}handleTextChange(e){const t=this._original;if(!t){return}const{text:s,column:n,line:i}=e;const r=s.split("\n")[i][n-1];if(r&&r.match(/\S/)||e.column>=t.column){this.current=e;return}this.reset(false)}createPatch(e){const t=this._original;const s=this._cursor;const n=this._current;if(!t||!s||!n){return undefined}let{start:i,end:r}=s;r=r+(n.text.length-t.text.length);return{start:i,end:r,value:e}}reset(e=false){if(!e&&this._subsetMatch){return}this._reset();this._stateChanged.emit(undefined)}_markup(e){const t=this._completionItems;let s=[];for(let n of t){const t=n.label.indexOf("(");const i=t>-1?n.label.substring(0,t):n.label;let r=_.StringExt.matchSumOfSquares(i,e);if(r){let e=_.StringExt.highlight(n.label,r.indices,y.mark);s.push(Object.assign(Object.assign({},n),{label:e.join(""),insertText:n.insertText?n.insertText:n.label,score:r.score}))}}s.sort(y.scoreCmp2);s.forEach((e=>{delete e.score}));return s}_filter(){const e=this._options||[];const t=this._query;if(!t){return(0,_.map)(e,(e=>({raw:e,text:e})))}const s=[];for(const n of e){const e=_.StringExt.matchSumOfSquares(n,t);if(e){const t=_.StringExt.highlight(n,e.indices,y.mark);s.push({raw:n,score:e.score,text:t.join("")})}}return(0,_.map)(s.sort(y.scoreCmp),(e=>({text:e.text,raw:e.raw})))}_reset(){this._current=null;this._cursor=null;this._completionItems=[];this._options=[];this._original=null;this._query="";this._subsetMatch=false;this._typeMap={};this._orderedTypes=[]}}var y;(function(e){const t=["function","instance","class","module","keyword"];const s=t.reduce(((e,t)=>{e[t]=null;return e}),{});function n(e){return`<mark>${e}</mark>`}e.mark=n;function i(e,t){const s=e.score-t.score;if(s!==0){return s}return e.raw.localeCompare(t.raw)}e.scoreCmp=i;function r(e,t){var s,n,i;const r=e.score-t.score;if(r!==0){return r}return(i=(s=e.insertText)===null||s===void 0?void 0:s.localeCompare((n=t.insertText)!==null&&n!==void 0?n:""))!==null&&i!==void 0?i:0}e.scoreCmp2=r;function o(e){const s=new Set;e.forEach((e=>{if(e.type&&!t.includes(e.type)&&!s.has(e.type)){s.add(e.type)}}));const n=Array.from(s);n.sort(((e,t)=>e.localeCompare(t)));return t.concat(n)}e.findOrderedCompletionItemTypes=o;function l(e){const n=Object.keys(e).map((t=>e[t])).filter((e=>!!e&&!(e in s))).sort(((e,t)=>e.localeCompare(t)));return t.concat(n)}e.findOrderedTypes=l})(y||(y={}));var v=s(90265);var x=s(85893);var I=s(86992);const b="jp-Completer-item";const w="jp-mod-active";const S=20;const E=300;const k=true;const M=10;class q extends I.Widget{constructor(e){super({node:document.createElement("div")});this._activeIndex=0;this._editor=null;this._model=null;this._resetFlag=false;this._selected=new r.Signal(this);this._visibilityChanged=new r.Signal(this);this._renderer=e.renderer||q.defaultRenderer;this.model=e.model||null;this.editor=e.editor||null;this.addClass("jp-Completer")}get editor(){return this._editor}set editor(e){this._editor=e}get selected(){return this._selected}get visibilityChanged(){return this._visibilityChanged}get model(){return this._model}set model(e){if(!e&&!this._model||e===this._model){return}if(this._model){this._model.stateChanged.disconnect(this.onModelStateChanged,this)}this._model=e;if(this._model){this._model.stateChanged.connect(this.onModelStateChanged,this)}}dispose(){this._model=null;super.dispose()}handleEvent(e){if(this.isHidden||!this._editor){return}switch(e.type){case"keydown":this._evtKeydown(e);break;case"mousedown":this._evtMousedown(e);break;case"scroll":this._evtScroll(e);break;default:break}}reset(){this._activeIndex=0;if(this._model){this._model.reset(true)}}selectActive(){const e=this.node.querySelector(`.${w}`);if(!e){this.reset();return}this._selected.emit(e.getAttribute("data-value"));this.reset()}onAfterAttach(e){document.addEventListener("keydown",this,k);document.addEventListener("mousedown",this,k);document.addEventListener("scroll",this,k)}onBeforeDetach(e){document.removeEventListener("keydown",this,k);document.removeEventListener("mousedown",this,k);document.removeEventListener("scroll",this,k)}onModelStateChanged(){if(this.isAttached){this._activeIndex=0;this.update()}}onUpdateRequest(e){const t=this._model;if(!t){return}if(this._resetFlag){this._resetFlag=false;if(!this.isHidden){this.hide();this._visibilityChanged.emit(undefined)}return}let s=null;let n=t.completionItems&&t.completionItems();if(n&&n.length){s=this._createCompletionItemNode(t,n)}else{s=this._createIItemNode(t)}if(!s){return}let i=s.querySelectorAll(`.${b}`)[this._activeIndex];i.classList.add(w);let r=document.createElement("div");r.className="jp-Completer-docpanel";s.appendChild(r);this._updateDocPanel();if(!t.query){const e=this._populateSubset();if(e){this.update();return}}if(this.isHidden){this.show();this._setGeometry();this._visibilityChanged.emit(undefined)}else{this._setGeometry()}}_createCompletionItemNode(e,t){if(!t.length){this._resetFlag=true;this.reset();if(!this.isHidden){this.hide();this._visibilityChanged.emit(undefined)}return null}let s=this.node;s.textContent="";let n=e.orderedTypes();let i=document.createElement("ul");i.className="jp-Completer-list";for(let r of t){if(!this._renderer.createCompletionItemNode){return null}let e=this._renderer.createCompletionItemNode(r,n);i.appendChild(e)}s.appendChild(i);return s}_createIItemNode(e){const t=(0,_.toArray)(e.items());if(!t||!t.length){this._resetFlag=true;this.reset();if(!this.isHidden){this.hide();this._visibilityChanged.emit(undefined)}return null}const s=(0,_.toArray)(e.options());if(s.length===1){this._selected.emit(s[0]);this.reset();return null}const n=this.node;n.textContent="";const i=e.orderedTypes();let r=document.createElement("ul");r.className="jp-Completer-list";for(const o of t){const t=this._renderer.createItemNode(o,e.typeMap(),i);r.appendChild(t)}n.appendChild(r);return n}_cycle(e){const t=this.node.querySelectorAll(`.${b}`);const s=this._activeIndex;let n=this.node.querySelector(`.${w}`);n.classList.remove(w);if(e==="up"){this._activeIndex=s===0?s:s-1}else if(e==="down"){this._activeIndex=s<t.length-1?s+1:s}else{const i=this.node.getBoundingClientRect().height;const r=n.getBoundingClientRect().height;const o=Math.floor(i/r);if(e==="pageUp"){this._activeIndex=s-o}else{this._activeIndex=s+o}this._activeIndex=Math.min(Math.max(0,this._activeIndex),t.length-1)}n=t[this._activeIndex];n.classList.add(w);let i=this.node.querySelector(".jp-Completer-list");x.ElementExt.scrollIntoViewIfNeeded(i,n);this._updateDocPanel()}_evtKeydown(e){if(this.isHidden||!this._editor){return}if(!this._editor.host.contains(e.target)){this.reset();return}switch(e.keyCode){case 9:{e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();const t=this._model;if(!t){return}const s=t.completionItems&&t.completionItems();if(s&&s.length===1){this._selected.emit(s[0].insertText||s[0].label);this.reset();return}const n=this._populateSubset();if(t.query){t.subsetMatch=true;this._selected.emit(t.query);t.subsetMatch=false}if(n){this.update()}return}case 27:e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();this.reset();return;case 33:case 34:case 38:case 40:{e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();const t=T.keyCodeMap[e.keyCode];this._cycle(t);return}default:return}}_evtMousedown(e){if(this.isHidden||!this._editor){return}if(T.nonstandardClick(e)){this.reset();return}let t=e.target;while(t!==document.documentElement){if(t.classList.contains(b)){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();this._selected.emit(t.getAttribute("data-value"));this.reset();return}if(t===this.node){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();return}t=t.parentElement}this.reset()}_evtScroll(e){if(this.isHidden||!this._editor){return}const{node:t}=this;if(t.contains(e.target)){return}requestAnimationFrame((()=>{this._setGeometry()}))}_populateSubset(){const{model:e}=this;if(!e){return false}const t=this.node.querySelectorAll(`.${b}`);const s=T.commonSubset(T.itemValues(t));const{query:n}=e;if(s&&s!==n&&s.indexOf(n)===0){e.query=s;return true}return false}_setGeometry(){const{node:e}=this;const t=this._model;const s=this._editor;if(!s||!t||!t.original||!t.cursor){return}const n=t.cursor.start;const i=s.getPositionAt(n);const r=s.getCoordinateForPosition(i);const o=window.getComputedStyle(e);const l=parseInt(o.borderLeftWidth,10)||0;const a=parseInt(o.paddingLeft,10)||0;v.HoverBox.setGeometry({anchor:r,host:s.host,maxHeight:E,minHeight:S,node:e,offset:{horizontal:l+a},privilege:"below",style:o})}_updateDocPanel(){var e,t;let s=this.node.querySelector(".jp-Completer-docpanel");if(!s){return}if(!((e=this.model)===null||e===void 0?void 0:e.completionItems)){return}let n=(t=this.model)===null||t===void 0?void 0:t.completionItems();if(!n){s.setAttribute("style","display:none");return}let i=n[this._activeIndex];if(!i){s.setAttribute("style","display:none");return}s.textContent="";if(i.documentation){let e=document.createElement("pre");e.textContent=i.documentation;s.appendChild(e);s.setAttribute("style","")}else{s.setAttribute("style","display:none")}}}(function(e){class t{createCompletionItemNode(e,t){let s=this._createBaseNode(e.insertText||e.label);if(e.deprecated){s.classList.add("jp-Completer-deprecated")}return this._constructNode(s,this._createMatchNode(e.label),!!e.type,e.type,t,e.icon)}createItemNode(e,t,s){return this._constructNode(this._createBaseNode(e.raw),this._createMatchNode(e.text),!g.JSONExt.deepEqual(t,{}),t[e.raw]||"",s)}_createBaseNode(e){const t=document.createElement("li");t.className=b;t.setAttribute("data-value",e);return t}_createMatchNode(e){const t=document.createElement("code");t.className="jp-Completer-match";t.innerHTML=v.defaultSanitizer.sanitize(e,{allowedTags:["mark"]});return t}_constructNode(e,t,s,n,i,r){if(r){const t=r.element({className:"jp-Completer-type jp-Completer-icon"});e.appendChild(t)}else if(s){const t=document.createElement("span");t.textContent=(n[0]||"").toLowerCase();const s=i.indexOf(n)%M+1;t.className="jp-Completer-type jp-Completer-monogram";t.setAttribute(`data-color-index`,s.toString());e.appendChild(t)}else{const t=document.createElement("span");t.className="jp-Completer-monogram";e.appendChild(t)}e.appendChild(t);if(s){e.title=n;const t=document.createElement("code");t.className="jp-Completer-typeExtended";t.textContent=n.toLocaleLowerCase();e.appendChild(t)}else{const t=document.createElement("span");t.className="jp-Completer-typeExtended";e.appendChild(t)}return e}}e.Renderer=t;e.defaultRenderer=new t})(q||(q={}));var T;(function(e){e.keyCodeMap={38:"up",40:"down",33:"pageUp",34:"pageDown"};function t(e){const t=e.length;let s="";if(t<2){return s}const n=e[0].length;for(let i=0;i<n;i++){const n=e[0][i];for(let r=1;r<t;r++){if(e[r][i]!==n){return s}}s+=n}return s}e.commonSubset=t;function s(e){const t=[];for(let s=0,n=e.length;s<n;s++){const n=e[s].getAttribute("data-value");if(n){t.push(n)}}return t}e.itemValues=s;function n(e){return e.button!==0||e.altKey||e.ctrlKey||e.shiftKey||e.metaKey}e.nonstandardClick=n})(T||(T={}));const N=new g.Token("@jupyterlab/completer:ICompletionManager")}}]);